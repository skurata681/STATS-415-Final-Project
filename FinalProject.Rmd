---
title: "STATS 415 Final Project"
author: "Sarah Kurata, Hannah Daane, Saman Verma"
date: "3/16/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(haven)
library(readr)
library(dplyr)
library(tidyverse)

#libraries for subset methods
library(SignifReg)
library(leaps)
#shrinkage methods
library(glmnet)
library(pls)
library(lares)
```

## Reading in Data

```{r, echo=FALSE}
#2009
bmx09 <- read_xpt("Data/2009/BMX_F.XPT")
bpx09 <- read_xpt("Data/2009/BPX_F.XPT")
demo09 <- read_xpt("Data/2009/DEMO_F.XPT")
dr109 <- read_xpt("Data/2009/DR1TOT_F.XPT")
smq09 <- read_xpt("Data/2009/SMQ_F.XPT")
tchol09 <- read_xpt("Data/2009/TCHOL_F.XPT")

data09 = merge(bmx09, bpx09, by = "SEQN", all.x = TRUE)
listy = list(demo09, dr109, smq09, tchol09)
for(i in 1:4){
  data09 = merge(data09, listy[[i]], by = "SEQN", all.x = TRUE)
}
write_csv(data09, "Data/2009/data2009.csv")

#2011
bmx11 <- read_xpt("Data/2011/BMX_G.XPT")
bpx11 <- read_xpt("Data/2011/BPX_G.XPT")
demo11 <- read_xpt("Data/2011/DEMO_G.XPT")
dr111 <- read_xpt("Data/2011/DR1TOT_G.XPT")
smq11 <- read_xpt("Data/2011/SMQ_G.XPT")
tchol11 <- read_xpt("Data/2011/TCHOL_G.XPT")

data11 = merge(bmx11, bpx11, by = "SEQN", all.x = TRUE)
listy = list(demo11, dr111, smq11, tchol11)
for(i in 1:4){
  data11 = merge(data11, listy[[i]], by = "SEQN", all.x = TRUE)
}
write_csv(data11, "Data/2011/data2011.csv")

#2013
bmx13 <- read_xpt("Data/2013/BMX_H.XPT")
bpx13 <- read_xpt("Data/2013/BPX_H.XPT")
demo13 <- read_xpt("Data/2013/DEMO_H.XPT")
dr113 <- read_xpt("Data/2013/DR1TOT_H.XPT")
smq13 <- read_xpt("Data/2013/SMQ_H.XPT")
tchol13 <- read_xpt("Data/2013/TCHOL_H.XPT")

data13 = merge(bmx13, bpx13, by = "SEQN", all.x = TRUE)
listy = list(demo13, dr113, smq13, tchol13)
for(i in 1:4){
  data13 = merge(data13, listy[[i]], by = "SEQN", all.x = TRUE)
}
write_csv(data13, "Data/2013/data2013.csv")

#2015
bmx15 <- read_xpt("Data/2015/BMX_I.XPT")
bpx15 <- read_xpt("Data/2015/BPX_I.XPT")
demo15 <- read_xpt("Data/2015/DEMO_I.XPT")
dr115 <- read_xpt("Data/2015/DR1TOT_I.XPT")
smq15 <- read_xpt("Data/2015/SMQ_I.XPT")
tchol15 <- read_xpt("Data/2015/TCHOL_I.XPT")

data15 = merge(bmx15, bpx15, by = "SEQN", all.x = TRUE)
listy = list(demo15, dr115, smq15, tchol15)
for(i in 1:4){
  data15 = merge(data15, listy[[i]], by = "SEQN", all.x = TRUE)
}
write_csv(data15, "Data/2015/data2015.csv")

#2017
bmx17 <- read_xpt("Data/2017/BMX_J.XPT")
bpx17 <- read_xpt("Data/2017/BPX_J.XPT")
demo17 <- read_xpt("Data/2017/DEMO_J.XPT")
dr117 <- read_xpt("Data/2017/DR1TOT_J.XPT")
smq17 <- read_xpt("Data/2017/SMQ_J.XPT")
tchol17 <- read_xpt("Data/2017/TCHOL_J.XPT")

data17 = merge(bmx17, bpx17, by = "SEQN", all.x = TRUE)
listy = list(demo17, dr117, smq17, tchol17)
for(i in 1:4){
  data17 = merge(data17, listy[[i]], by = "SEQN", all.x = TRUE)
}
write_csv(data17, "Data/2017/data2017.csv")

#Total
data = bind_rows(data09,data11)
listy = list(data13,data15,data17)
for(i in 1:3){
  data = bind_rows(data, listy[[i]])
}
train = read_csv("Data/Kaggle/train.csv")
train = merge(train, data, by = "SEQN", all.x = TRUE)
train=train[, colSums(is.na(train))==0]
train = train[, -which(names(train)%in%c("SMDUPCA", "SMD100BR", "DR1DRSTZ", "DRABF", "RIDSTATR"))]
write_csv(train, "Data/Total/train.csv")
test = read_csv("Data/Kaggle/test.csv")
test = merge(test, data, by = "SEQN", all.x = TRUE)
test=test[, colSums(is.na(test))==0]
test = test[, -which(names(test)%in%c("SMDUPCA", "SMD100BR", "DR1DRSTZ", "DRABF", "RIDSTATR"))]
drops = c(setdiff(names(test), names(train)))
test = test[,!(names(test) %in% drops)]
write_csv(test, "Data/Total/test.csv")
```


```{r}
#original attempt
view(train)
model1 = glm(y ~ BMDSTATS, data = train)
x = predict(model1, newdata = test)
firstprediction = data.frame(test$SEQN, x)
firstprediction <-  firstprediction%>%rename(SEQN=test.SEQN)
firstprediction<-  firstprediction%>%rename(y=x)
write_csv(firstprediction, "Predictions/Kaggle/firstPrediction.csv")

#KAGGLE ATTEMPTS. TRIED BACKWARD AND FORWARD SELECTION WITH REGSUBSETS
    #LOO-CV
    # n_predictors <- ncol(train) - 1
    # regfit.full <- regsubsets(y ~ ., data = train, nvmax = n_predictors, method = "backward")
    # reg.summary <- summary(regfit.full)
    # reg.summary$rsq
#BY RUNNING BACKWARDS AND FORWARD SELECTION WE GOT LOW RSQ VALUE OF APPROXIMATELY .32

#KAGGLE ATTEMPTS FORWARD SELECTION, this method looks at p-values
nullmodel <- lm(y ~ 1, data = non_correlated)
fullmodel <- lm(y ~ ., data = non_correlated)
select.p.fwd <- SignifReg(fit = nullmodel,
scope = list(lower = formula(nullmodel), upper = formula(fullmodel)),
alpha = 0.05, direction = "forward",
adjust.method = "none", trace = FALSE)
summary(select.p.fwd)

#resulting model from p-value
forward_selection_model_signifreg <-lm(formula = y ~ SMAQUEX2 + BMXARML + DMDBORN4 + BPXSY1 + BPACSZ + DR1TSUGR + DR1TFIBE + RIDAGEYR + DR1TKCAL + BMXWT + BMXBMI + BMXHT + BMXWAIST + RIDEXMON + BMXARMC + SIAPROXY + DR1TATOC + FIALANG + DR1TS100 + SEQN + LBXTC + SIAINTRP + WTINT2YR, data = train)
summary(forward_selection_model_signifreg)

summary(lm(y~., train))

#check model diagnostics of forward selection model
ggplot() + geom_point(mapping = aes(x = fitted(forward_selection_model_signifreg), residuals(forward_selection_model_signifreg))) + geom_hline(yintercept = 0) + xlab("Fitted values") + ylab("Residuals")

#normal qq plot shows that the distribution is longtailed, cauchy. this is concerning for least squares
qqnorm(forward_selection_model_signifreg$residuals, ylab = "Residuals")
qqline(forward_selection_model_signifreg$residuals)

myvars <- names(train) %in% c("LBXTC", "WTINT2YR","DR1TPFAT", "DR1TMFAT", "DR1TFOLA", "DR1TSFAT")
non_correlated<-train[!myvars]

#no nonlinear relationships :/ checked for nonlinear relationships multiple ways
#ONE HIGHLY CORRELATED VARIABLES GIVING ME ERROR
cor(train)[cor(train)>.9999 & cor(train)<1]
#FOUND HIGHLY CORRELATED VALUES
corr_cross(non_correlated, # name of dataset
  max_pvalue = 0.05, # display only significant correlations (at 5% level)
  top = 10 # display top 10 couples of variables (by correlation coefficient)
)

nullmodel <- lm(y ~ 1, data = non_correlated)
fullmodel <- lm(y ~ ., data = non_correlated)
select.p.fwd <- SignifReg(fit = fullmodel,
scope = list(lower = formula(nullmodel), upper = formula(fullmodel)),
alpha = 0.05, direction = "backward",
adjust.method = "none", trace = FALSE)
summary(select.p.fwd)



#attempt ridge and lasso

```


```{r}
#Caffeine
library(Hmisc)
library(corrplot)
correlationmatrix = cor(train[,c(which( colnames(train)=="DRD340" ), which( colnames(train)=="DRD350A" ), which( colnames(train)=="DRD350B" ), which( colnames(train)=="DRD350C" ), which( colnames(train)=="DRD350D" ), which( colnames(train)=="DRD350E" ))])
corrplot(correlationmatrix)
palette = colorRampPalette(c("green", "white", "red")) (20)
heatmap(x = correlationmatrix, col = palette, symm = TRUE)
cor(train$DR1_330Z, train[1:100])
```


```{r}
library(data.table)
library(tidyr)
classification = copy(data)
classification = classification %>% drop_na("SMQ905")
classification = classification %>% drop_na("SMD641")
classification = classification %>% drop_na("DR1TALCO")
correlationmatrix = cor(classification[,c(which( colnames(classification)=="SMQ905" ), which( colnames(classification)=="SMD641" ), which( colnames(classification)=="DR1TALCO" ))])
corrplot(correlationmatrix)
palette = colorRampPalette(c("green", "white", "red")) (20)
heatmap(x = correlationmatrix, col = palette, symm = TRUE)
```


```{r}
pbcd09 = read_xpt("Data/2009/PBCD_F.XPT")
pbcd11 = read_xpt("Data/2011/PBCD_G.XPT")
pbcd13 = read_xpt("Data/2013/PBCD_H.XPT")
pbcd15 = read_xpt("Data/2015/PBCD_I.XPT")
pbcd17 = read_xpt("Data/2017/PBCD_J.XPT")
datapbcd = merge(pbcd09, pbcd11, by = "SEQN", all.x = TRUE)
listy = list(pbcd13, pbcd15, pbcd17)
for(i in 1:3){
  datapbcd = merge(datapbcd, listy[[i]], by = "SEQN", all.x = TRUE)
}
regression = merge(data, datapbcd, by = "SEQN", all.x = TRUE)
regression = regression %>% drop_na("SMQ905")
regression = regression %>% drop_na("SMD641")
regression = regression %>% drop_na("DR1TALCO")
```